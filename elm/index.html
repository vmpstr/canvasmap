<!doctype html>
<head>
  <link rel=stylesheet href='styles/styles.css'></link>
  <link rel=stylesheet href='styles/scroller-styles.css'></link>
  <link rel=stylesheet href='styles/resizers.css'></link>
  <link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
  <meta charset="utf-8">
</head>

<body>
  <div id="map"></div>
</body>


<script src="map.js"></script>
<script src="js/child-area.js"></script>
<script src="js/node-label.js"></script>
<script src="js/resizer-events.js"></script>
<script src="js/drag-events.js"></script>
<script>
function onEditLabel(e) {
  // raf since we could be just attaching the node.
  requestAnimationFrame(() => {
    document.getElementById(e.targetId).querySelector("node-label").edit();
  });
}

const kStateVersion = "3"
function saveState(nodes) {
  localStorage.setItem("mm-version", kStateVersion);
  localStorage.setItem("mm-nodes", JSON.stringify(nodes));
}

function loadState() {
  const version = localStorage.getItem("mm-version");
  if (!version || version !== kStateVersion) {
    window.app.ports.portOnLoadState.send([]);
    return;
  }
  const nodes = JSON.parse(localStorage.getItem("mm-nodes"));
  window.app.ports.portOnLoadState.send(nodes);
}

function onNodeSelected(e) {
  // Since we could have just created the node, defer until
  // DOM actually reflects the new state.
  requestAnimationFrame(() => {
    const target = document.getElementById(e.targetId);
    if (target)
      target.scrollIntoViewIfNeeded();
  });
}

onload = () => {
  window.app = Elm.Map.init({ node: document.getElementById("map") });
  window.app.ports.portEditLabel.subscribe(onEditLabel);
  window.app.ports.portSaveState.subscribe(saveState);
  window.app.ports.portLoadState.subscribe(loadState);
  window.app.ports.portNodeSelected.subscribe(onNodeSelected);

  initResizerEvents();
  initDragEvents();
  document.addEventListener("keydown", (e) => {
    // TODO: Maybe filter based on what is handled?
    e.preventDefault();
    window.app.ports.portOnKeyDown.send({ code: e.code });
  })
};
</script>

